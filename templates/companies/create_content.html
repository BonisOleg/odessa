{% load static %}

<!-- –¢—ñ–ª—å–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è HTMX (–±–µ–∑ layout) -->

{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="message message--{{ message.tags|default:'info' }}" role="alert">
        <div class="message__text">{{ message }}</div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if form.errors %}
<div class="message message--error" role="alert">
    <div class="message__title">–ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó</div>
    <div class="message__text">
        <ul>
            {% for field, errors in form.errors.items %}
            {% for error in errors %}
            <li>{{ field }}: {{ error }}</li>
            {% endfor %}
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<form class="card" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-grid">
        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="form-column">
            <div class="form-group">
                <label class="form-group__label form-group__label--required">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                <input type="text" class="form-control {% if form.name.errors %}form-control--error{% endif %}" name="name" value="{{ form.name.value|default:'' }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                {% if form.name.errors %}
                {% for error in form.name.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–ê–¥—Ä–µ—Å–∞</label>
                <div class="address-inputs" id="address-list">
                    <div class="address-input-group">
                        <input type="text" class="form-control" name="addresses[]" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
                        <label class="address-favorite">
                            <input type="radio" name="favorite_address" value="0">
                            <span class="favorite-star">‚≠ê</span>
                        </label>
                    </div>
                </div>
                <button type="button" class="button button--sm button--secondary" data-action="add-address" style="margin-top: var(--spacing-xs);">+ –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</button>
                <span class="form-hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–æ –∑–≤–µ–∑–¥–æ–π</span>
            </div>
            
            <div class="form-group">
                <label class="form-group__label form-group__label--required">–¢–µ–ª–µ—Ñ–æ–Ω—ã + –ò–º–µ–Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</label>
                <div class="phone-inputs" id="phone-list">
                    <div class="phone-input-group">
                        <input type="tel" class="form-control" name="phones[]" placeholder="+380991234567" inputmode="tel" autocomplete="tel" required>
                        <input type="text" class="form-control" name="contact_names[]" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
                        <label class="phone-favorite">
                            <input type="radio" name="favorite_phone" value="0">
                            <span class="favorite-star">‚≠ê</span>
                        </label>
                    </div>
                </div>
                <button type="button" class="button button--sm button--secondary" data-action="add-phone">+ –î–æ–±–∞–≤–∏—Ç—å
                    —Ç–µ–ª–µ—Ñ–æ–Ω</button>
                <span class="form-hint">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–æ –∑–≤–µ–∑–¥–æ–π</span>
            </div>

            <div class="form-group">
                <label class="form-group__label">
                    üí¨ Telegram
                </label>
                <input type="text" class="form-control {% if form.telegram.errors %}form-control--error{% endif %}" name="telegram" value="{{ form.telegram.value|default:'' }}" placeholder="@username –∏–ª–∏ https://t.me/username">
                {% if form.telegram.errors %}
                {% for error in form.telegram.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–°–∞–π—Ç</label>
                <input type="url" class="form-control {% if form.website.errors %}form-control--error{% endif %}" name="website" value="{{ form.website.value|default:'' }}" placeholder="https://example.com">
                <span class="form-hint">–ë—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏</span>
                {% if form.website.errors %}
                {% for error in form.website.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">Instagram</label>
                <input type="text" class="form-control {% if form.instagram.errors %}form-control--error{% endif %}" name="instagram" value="{{ form.instagram.value|default:'' }}" placeholder="@username">
                <span class="form-hint">–ë—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏</span>
                {% if form.instagram.errors %}
                {% for error in form.instagram.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                <textarea class="form-control {% if form.keywords.errors %}form-control--error{% endif %}" name="keywords" rows="3" placeholder="CRM, Django, —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥">{{ form.keywords.value|default:'' }}</textarea>
                <span class="form-hint">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</span>
                {% if form.keywords.errors %}
                {% for error in form.keywords.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="form-column">
            {% if user_country %}
            <input type="hidden" name="country" id="country-select" value="{{ user_country.id }}">
            {% else %}
            <div class="form-group">
                <label class="form-group__label form-group__label--required">–°—Ç—Ä–∞–Ω–∞</label>
                <select class="form-select" name="country" id="country-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                    {% for country in countries %}
                    <option value="{{ country.id }}">{{ country.name }} {{ country.flag_emoji }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="form-group">
                <label class="form-group__label form-group__label--required">–ì–æ—Ä–æ–¥</label>
                <select class="form-select {% if form.city.errors %}form-control--error{% endif %}" name="city" id="city-select" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                    {% for city in cities %}
                    <option value="{{ city.id }}" data-country="{{ city.country.id }}" {% if form.city.value|stringformat:"s" == city.id|stringformat:"s" %}selected{% endif %}>{{ city.name }}</option>
                    {% endfor %}
                </select>
                {% if form.city.errors %}
                {% for error in form.city.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label form-group__label--required">–†–∞–∑–¥–µ–ª</label>
                <select class="form-select {% if form.category.errors %}form-control--error{% endif %}" name="category" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if form.category.value|stringformat:"s" == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
                {% if form.category.errors %}
                {% for error in form.category.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label form-group__label--required">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select {% if form.status.errors %}form-control--error{% endif %}" name="status" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
                    {% for status in statuses %}
                    <option value="{{ status.id }}" {% if form.status.value|stringformat:"s" == status.id|stringformat:"s" %}selected{% endif %}>{{ status.name }}</option>
                    {% endfor %}
                </select>
                {% if form.status.errors %}
                {% for error in form.status.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</label>
                <input type="date" class="form-control {% if form.call_date.errors %}form-control--error{% endif %}" name="call_date" value="{{ form.call_date.value|default:'' }}">
                <span class="form-hint">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</span>
                {% if form.call_date.errors %}
                {% for error in form.call_date.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea class="form-control {% if form.short_comment.errors %}form-control--error{% endif %}" name="short_comment" rows="3" maxlength="500">{{ form.short_comment.value|default:'' }}</textarea>
                <span class="form-hint">–ú–∞–∫—Å. 500 —Å–∏–º–≤–æ–ª–æ–≤</span>
                {% if form.short_comment.errors %}
                {% for error in form.short_comment.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-group__label">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                <div class="rich-text-editor">
                    <div class="rich-text-toolbar">
                        <button type="button" class="toolbar-btn" data-command="bold" title="–ñ–∏—Ä–Ω—ã–π">B</button>
                        <button type="button" class="toolbar-btn" data-command="italic" title="–ö—É—Ä—Å–∏–≤">I</button>
                        <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="–°–ø–∏—Å–æ–∫">‚Ä¢</button>
                        <button type="button" class="toolbar-btn" data-command="createLink" title="–°—Å—ã–ª–∫–∞">üîó</button>
                        <button type="button" class="toolbar-btn" data-command="insertEmoji" title="–≠–º–æ–¥–∑–∏">üòÄ</button>
                    </div>
                    <div class="rich-text-content" contenteditable="true" data-name="full_description" role="textbox" aria-multiline="true" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, —Å—Å—ã–ª–∫–∏, –∏–∫–æ–Ω–∫–∏...">{{ form.full_description.value|default:'' }}</div>
                    <textarea class="form-control {% if form.full_description.errors %}form-control--error{% endif %}" name="full_description" style="display: none;">{{ form.full_description.value|default:'' }}</textarea>
                </div>
                {% if form.full_description.errors %}
                {% for error in form.full_description.errors %}
                <span class="form-error">{{ error }}</span>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –°–µ–∫—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤ -->
    <div class="form-section">
        <div class="form-group">
            <label class="form-group__label">–õ–æ–≥–æ—Ç–∏–ø</label>
            <input type="file" class="form-control" name="logo" accept="image/*">
            <div class="image-preview"></div>
        </div>

        <div class="form-group">
            <label class="form-group__label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
            <input type="file" class="form-control" name="photos" accept="image/*" multiple>
            <div class="images-preview"></div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
    <div class="form-actions">
        <button type="submit" class="button button--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a href="{% url 'myapp:company_list' %}" hx-get="{% url 'myapp:company_list' %}" hx-target="#main-content" hx-push-url="true"
            class="button button--secondary">–û—Ç–º–µ–Ω–∞</a>
    </div>
</form>

<script defer>
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤
    document.querySelector('[data-action="add-phone"]').addEventListener('click', function () {
        const phoneList = document.getElementById('phone-list');
        const index = phoneList.children.length;
        const html = `
            <div class="phone-input-group">
                <input type="tel" class="form-control" name="phones[]" placeholder="+380991234567" inputmode="tel" autocomplete="tel">
                <input type="text" class="form-control" name="contact_names[]" placeholder="–Ü–º'—è –∫–æ–Ω—Ç–∞–∫—Ç—É">
                <label class="phone-favorite">
                    <input type="radio" name="favorite_phone" value="${index}">
                    <span class="favorite-star">‚≠ê</span>
                </label>
                <button type="button" class="button button--sm button--danger remove-phone">‚àí</button>
            </div>
        `;
        phoneList.insertAdjacentHTML('beforeend', html);
    });

    // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É —Ç–∞ –∞–¥—Ä–µ—Å–∏
    document.addEventListener('click', function (e) {
        if (e.target.closest('.remove-phone')) {
            e.target.closest('.phone-input-group').remove();
        }
        if (e.target.closest('.remove-address')) {
            e.target.closest('.address-input-group').remove();
        }
    });
    
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–∏
    document.querySelector('[data-action="add-address"]')?.addEventListener('click', function() {
        const addressList = document.getElementById('address-list');
        const index = addressList.children.length;
        const html = `
            <div class="address-input-group" style="display: flex; gap: var(--spacing-xs); align-items: center; margin-bottom: var(--spacing-xs);">
                <input type="text" class="form-control" name="addresses[]" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
                <label class="address-favorite" style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="favorite_address" value="${index}">
                    <span class="favorite-star">‚≠ê</span>
                </label>
                <button type="button" class="button button--sm button--danger remove-address">‚àí</button>
            </div>
        `;
        addressList.insertAdjacentHTML('beforeend', html);
    });

    // ==========================================================================
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
    // ==========================================================================
    function checkDuplicates(fieldName, fieldValue) {
        if (!fieldValue || !fieldValue.trim()) return;
        
        const params = new URLSearchParams();
        params.append(fieldName, fieldValue.trim());
        
        fetch('{% url "myapp:company_check_duplicates" %}?' + params.toString())
            .then(response => response.json())
            .then(data => {
                const field = document.querySelector(`input[name="${fieldName}"], input[name="${fieldName}[]"]`);
                if (!field) return;
                
                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –ø–æ–º–∏–ª–∫–∏
                const existingError = field.parentElement.querySelector('.form-error');
                if (existingError) {
                    existingError.remove();
                }
                field.classList.remove('input-error');
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (data[fieldName] && data[fieldName].exists) {
                    field.classList.add('input-error');
                    const hint = document.createElement('span');
                    hint.className = 'form-error';
                    hint.textContent = `‚ö†Ô∏è ${fieldName === 'phone' ? '–¢–µ–ª–µ—Ñ–æ–Ω' : fieldName === 'website' ? '–°–∞–π—Ç' : fieldName === 'instagram' ? 'Instagram' : 'Telegram'} –≤–∂–µ —ñ—Å–Ω—É—î –≤ –∫–æ–º–ø–∞–Ω—ñ—ó "${data[fieldName].company}"`;
                    field.parentElement.appendChild(hint);
                }
            })
            .catch(error => {
                console.error('Error checking duplicates:', error);
            });
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ (–¥–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞–Ω–∏—Ö –ø–æ–ª—ñ–≤)
    document.addEventListener('blur', function (e) {
        if (e.target.matches('input[name="phones[]"]')) {
            checkDuplicates('phone', e.target.value);
        }
    }, true);
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –ø–æ–ª—ñ–≤
    document.querySelectorAll('input[name="phones[]"]').forEach(function (input) {
        input.addEventListener('blur', function () {
            checkDuplicates('phone', this.value);
        });
    });

    // ==========================================================================
    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –º—ñ—Å—Ç –ø–æ –∫—Ä–∞—ó–Ω—ñ
    // ==========================================================================
    const countrySelect = document.getElementById('country-select');
    const citySelect = document.getElementById('city-select');
    
    if (countrySelect && citySelect) {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—Å—ñ –º—ñ—Å—Ç–∞ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
        const allCities = Array.from(citySelect.options).slice(1); // –ë–µ–∑ –ø–µ—Ä—à–æ–≥–æ option "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥"
        
        function filterCitiesByCountry(countryId) {
            // –û—á–∏—â–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –º—ñ—Å—Ç
            citySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
            
            if (!countryId) {
                // –Ø–∫—â–æ –∫—Ä–∞—ó–Ω–∞ –Ω–µ –≤–∏–±—Ä–∞–Ω–∞, –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ –º—ñ—Å—Ç–∞
                allCities.forEach(function(option) {
                    citySelect.appendChild(option.cloneNode(true));
                });
                return;
            }
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –º—ñ—Å—Ç–∞ –ø–æ –∫—Ä–∞—ó–Ω—ñ
            allCities.forEach(function(option) {
                if (option.getAttribute('data-country') === countryId.toString()) {
                    citySelect.appendChild(option.cloneNode(true));
                }
            });
        }
        
        // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ –∫—Ä–∞—ó–Ω–∏
        countrySelect.addEventListener('change', function() {
            filterCitiesByCountry(this.value);
            citySelect.value = ''; // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä –º—ñ—Å—Ç–∞
        });
        
        // –Ø–∫—â–æ –∫—Ä–∞—ó–Ω–∞ –≤–∂–µ –≤–∏–±—Ä–∞–Ω–∞ (hidden input), —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –æ–¥—Ä–∞–∑—É
        if (countrySelect.type === 'hidden') {
            filterCitiesByCountry(countrySelect.value);
        }
    }

    // ==========================================================================
    // –ü–æ—à—É–∫ –º—ñ—Å—Ç –ø–æ –±—É–∫–≤—ñ
    // ==========================================================================
    const citySearchInput = document.getElementById('city-search');
    if (citySearchInput && citySelect) {
        citySearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const options = citySelect.querySelectorAll('option');
            
            options.forEach(function(option) {
                if (option.value === '') {
                    // –ó–∞–ª–∏—à–∞—î–º–æ –ø–µ—Ä—à–∏–π option "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥"
                    return;
                }
                
                const cityName = option.getAttribute('data-city-name') || option.textContent.toLowerCase();
                if (cityName.includes(searchTerm)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
        });
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ website
    const websiteInput = document.querySelector('input[name="website"]');
    if (websiteInput) {
        websiteInput.addEventListener('blur', function () {
            checkDuplicates('website', this.value);
        });
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ instagram
    const instagramInput = document.querySelector('input[name="instagram"]');
    if (instagramInput) {
        instagramInput.addEventListener('blur', function () {
            checkDuplicates('instagram', this.value);
        });
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ telegram
    const telegramInput = document.querySelector('input[name="telegram"]');
    if (telegramInput) {
        telegramInput.addEventListener('blur', function () {
            checkDuplicates('telegram', this.value);
        });
    }
</script>