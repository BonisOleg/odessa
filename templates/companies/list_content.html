{% load static %}

<div class="page-header">
    <p>–í—Å–µ–≥–æ: <strong>{{ total_count }} –∫–æ–º–ø–∞–Ω–∏–π</strong> | –ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π: <strong>+{{ new_count }}</strong></p>
</div>

<!-- –§—ñ–ª—å—Ç—Ä–∏ -->
<div class="card filters-card">
    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
            <div class="multiselect-dropdown">
                <button type="button" class="multiselect-trigger" data-filter="status">
                    <span class="multiselect-text">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</span>
                    <span class="dropdown__arrow">‚ñæ</span>
                </button>
                <div class="multiselect-options">
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-–≤-—Ä–∞–±–æ—Ç–µ" value="–í —Ä–∞–±–æ—Ç–µ" data-filter="status">
                        <label for="status-–≤-—Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-–≥–æ—Ä—è—á–∏–π" value="–ì–æ—Ä—è—á–∏–π" data-filter="status">
                        <label for="status-–≥–æ—Ä—è—á–∏–π">–ì–æ—Ä—è—á–∏–π</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-—Ö–æ—Ä–æ—à–∏–π" value="–•–æ—Ä–æ—à–∏–π" data-filter="status">
                        <label for="status-—Ö–æ—Ä–æ—à–∏–π">–•–æ—Ä–æ—à–∏–π</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-–ø–æ–∑–∂–µ" value="–ü–æ–∑–∂–µ" data-filter="status">
                        <label for="status-–ø–æ–∑–∂–µ">–ü–æ–∑–∂–µ</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-—Ç–µ–ø–ª—ã–π" value="–¢–µ–ø–ª—ã–π" data-filter="status">
                        <label for="status-—Ç–µ–ø–ª—ã–π">–¢–µ–ø–ª—ã–π</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">–ì–æ—Ä–æ–¥</label>
            <div class="multiselect-dropdown">
                <button type="button" class="multiselect-trigger" data-filter="city">
                    <span class="multiselect-text">–í—Å–µ –≥–æ—Ä–æ–¥–∞</span>
                    <span class="dropdown__arrow">‚ñæ</span>
                </button>
                <div class="multiselect-options">
                    <div class="multiselect-option">
                        <input type="checkbox" id="city-–∫–∏–µ–≤" value="–ö–∏–µ–≤" data-filter="city">
                        <label for="city-–∫–∏–µ–≤">–ö–∏–µ–≤</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="city-—Ö–∞—Ä—å–∫–æ–≤" value="–•–∞—Ä—å–∫–æ–≤" data-filter="city">
                        <label for="city-—Ö–∞—Ä—å–∫–æ–≤">–•–∞—Ä—å–∫–æ–≤</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="city-–ª—å–≤–æ–≤" value="–õ—å–≤–æ–≤" data-filter="city">
                        <label for="city-–ª—å–≤–æ–≤">–õ—å–≤–æ–≤</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="city-–æ–¥–µ—Å—Å–∞" value="–û–¥–µ—Å—Å–∞" data-filter="city">
                        <label for="city-–æ–¥–µ—Å—Å–∞">–û–¥–µ—Å—Å–∞</label>
                    </div>
                    <div class="multiselect-option">
                        <input type="checkbox" id="city-–¥–Ω–µ–ø—Ä" value="–î–Ω–µ–ø—Ä" data-filter="city">
                        <label for="city-–¥–Ω–µ–ø—Ä">–î–Ω–µ–ø—Ä</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</label>
            <select class="form-select filter-select">
                <option value="">–í—Å–µ –¥–∞—Ç—ã</option>
                <option>–°–µ–≥–æ–¥–Ω—è</option>
                <option>–í—á–µ—Ä–∞</option>
                <option>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
                <option>–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">–†–∞–∑–¥–µ–ª</label>
            <select class="form-select filter-select">
                <option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
                <option>IT-—É—Å–ª—É–≥–∏</option>
                <option>–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
                <option>–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                <option>–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">–î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</label>
            <select class="form-select filter-select">
                <option value="">–í—Å–µ –¥–∞—Ç—ã</option>
                <option>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
                <option>–°–µ–≥–æ–¥–Ω—è</option>
                <option>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</option>
            </select>
        </div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü—è –∫–æ–º–ø–∞–Ω—ñ–π -->
<div class="card">
    <div class="table-responsive">
        <table class="table company-table">
            <thead class="table__head">
                <tr>
                    <th class="table__th">ID</th>
                    <th class="table__th">–õ–æ–≥–æ + –ò–º—è</th>
                    <th class="table__th">–¢–µ–ª–µ—Ñ–æ–Ω + –ò–º—è</th>
                    <th class="table__th">Instagram</th>
                    <th class="table__th">–°–∞–π—Ç</th>
                    <th class="table__th">–°—Ç–∞—Ç—É—Å</th>
                    <th class="table__th">–ì–æ—Ä–æ–¥</th>
                    <th class="table__th">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                    <th class="table__th">–†–∞–∑–¥–µ–ª</th>
                    <th class="table__th">–î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</th>
                    <th class="table__th">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th class="table__th">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for company in companies %}
                {% with favorite_phone=company.phones|first %}
                <tr class="table__row" data-status="{{ company.status }}" data-city="{{ company.city }}"
                    data-updated="{{ company.updated_date|slice:" :10" }}">
                    <td class="table__td">
                        <span class="text-muted">{{ company.client_id }}</span>
                    </td>
                    <td class="table__td">
                        <div class="company-cell">
                            <img src="{{ company.logo }}" alt="{{ company.name }}" class="company-logo">
                            <a href="/companies/{{ company.id }}/" hx-get="/companies/{{ company.id }}/"
                                hx-target="#main-content" hx-push-url="true" class="company-name-link">{{ company.name }}</a>
                        </div>
                    </td>
                    <td class="table__td">
                        <div class="phone-cell">
                            {% if favorite_phone %}
                            <span class="phone-number">{{ favorite_phone.number }}</span>
                            {% if favorite_phone.favorite %}<span class="phone-star">‚≠ê</span>{% endif %}
                            <span class="contact-name">{{ favorite_phone.name }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="table__td">{% if company.telegram %}{{ company.telegram }}{% else %}-{% endif %}</td>
                    <td class="table__td">
                        {% if company.website %}
                        <a href="{{ company.website }}" target="_blank" rel="noopener" class="website-link">üåê</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="table__td"><span class="badge {{ company.status_badge }}">{{ company.status }}</span>
                    </td>
                    <td class="table__td">{{ company.city }}</td>
                    <td class="table__td">{{ company.updated_date|slice:":10" }}</td>
                    <td class="table__td">
                        <span class="badge {{ company.category_badge }}">{{ company.category }}</span>
                    </td>
                    <td class="table__td">
                        {% if company.call_date %}
                        <span class="call-date" data-call-date="{{ company.call_date }}">{{ company.call_date_display }}</span>
                        {% else %}
                        <span class="call-date" data-call-date="">-</span>
                        {% endif %}
                    </td>
                    <td class="table__td">{{ company.short_comment|default:"-" }}</td>
                    <td class="table__td">
                        <div class="table-actions">
                            <button type="button" class="icon-btn favorite-btn" data-id="{{ company.id }}"
                                title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">‚≠ê</button>
                            {% if company.telegram %}
                            <button type="button" class="icon-btn telegram-btn" data-telegram="{{ company.telegram }}"
                                title="Telegram">üí¨</button>
                            {% endif %}
                            <a href="/companies/{{ company.id }}/edit/" hx-get="/companies/{{ company.id }}/edit/"
                                hx-target="#main-content" hx-push-url="true" class="icon-btn"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            <button type="button" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å"
                                hx-get="/companies/{{ company.id }}/delete/" hx-target="body"
                                hx-swap="beforeend">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="12" class="table__td text-center">
                        <p class="text-muted">–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    <div class="pagination">
        <button type="button" class="pagination__btn pagination__btn--prev" disabled>‚Üê –ù–∞–∑–∞–¥</button>
        <span class="pagination__info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 2</span>
        <button type="button" class="pagination__btn pagination__btn--next">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
    </div>
</div>

<script defer>
    // ==========================================================================
    // Multiselect Dropdown
    // ==========================================================================
    document.addEventListener('click', function (e) {
        const trigger = e.target.closest('.multiselect-trigger');
        if (trigger) {
            e.preventDefault();
            e.stopPropagation();
            const dropdown = trigger.closest('.multiselect-dropdown');
            const isOpen = dropdown.classList.contains('is-open');

            // –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ
            document.querySelectorAll('.multiselect-dropdown.is-open').forEach(function (open) {
                if (open !== dropdown) open.classList.remove('is-open');
            });

            // –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π
            if (isOpen) {
                dropdown.classList.remove('is-open');
            } else {
                dropdown.classList.add('is-open');
            }
        } else if (!e.target.closest('.multiselect-dropdown')) {
            // –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞
            document.querySelectorAll('.multiselect-dropdown.is-open').forEach(function (dropdown) {
                dropdown.classList.remove('is-open');
            });
        }
    });

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É multiselect
    function updateMultiselectText(dropdown) {
        const checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const text = dropdown.querySelector('.multiselect-text');
        if (checked.length === 0) {
            const filter = dropdown.querySelector('.multiselect-trigger').getAttribute('data-filter');
            text.textContent = filter === 'status' ? '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã' : '–í—Å–µ –≥–æ—Ä–æ–¥–∞';
        } else if (checked.length === 1) {
            text.textContent = checked[0].value;
        } else {
            text.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${checked.length}`;
        }
    }

    // ==========================================================================
    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ç–∞–±–ª–∏—Ü—ñ
    // ==========================================================================
    function filterTable() {
        const statusChecks = document.querySelectorAll('input[data-filter="status"]:checked');
        const cityChecks = document.querySelectorAll('input[data-filter="city"]:checked');
        const selectedStatuses = Array.from(statusChecks).map(cb => cb.value);
        const selectedCities = Array.from(cityChecks).map(cb => cb.value);

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(function (row) {
            let show = true;

            if (selectedStatuses.length > 0) {
                const rowStatus = row.getAttribute('data-status');
                if (!selectedStatuses.includes(rowStatus)) show = false;
            }

            if (selectedCities.length > 0) {
                const rowCity = row.getAttribute('data-city');
                if (!selectedCities.includes(rowCity)) show = false;
            }

            row.style.display = show ? '' : 'none';
        });
    }

    // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω checkbox
    document.addEventListener('change', function (e) {
        if (e.target.matches('input[data-filter]')) {
            const dropdown = e.target.closest('.multiselect-dropdown');
            updateMultiselectText(dropdown);
            filterTable();
        }
    });

    // ==========================================================================
    // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ –¥–∞—Ç—ñ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ω–æ–≤—ñ –∑–≤–µ—Ä—Ö—É)
    // ==========================================================================
    function sortTableByDate() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

        rows.sort(function (a, b) {
            const aId = a.querySelector('.favorite-btn')?.getAttribute('data-id');
            const bId = b.querySelector('.favorite-btn')?.getAttribute('data-id');
            const aFav = favorites.includes(aId) ? 0 : 1;
            const bFav = favorites.includes(bId) ? 0 : 1;

            if (aFav !== bFav) return aFav - bFav;

            const aDate = a.getAttribute('data-updated') || '';
            const bDate = b.getAttribute('data-updated') || '';
            return bDate.localeCompare(aDate);
        });

        rows.forEach(function (row) {
            tbody.appendChild(row);
        });
    }

    // ==========================================================================
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ—ó –¥–∞—Ç–∏ –∑–≤–æ–Ω–∫–∞
    // ==========================================================================
    function checkCallDates() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll('.call-date[data-call-date]').forEach(function (el) {
            const dateStr = el.getAttribute('data-call-date');
            if (!dateStr || dateStr === '-') return;

            const callDate = new Date(dateStr);
            callDate.setHours(0, 0, 0, 0);

            el.classList.remove('past', 'future');
            if (callDate < today) {
                el.classList.add('past');
            } else {
                el.classList.add('future');
            }
        });
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    sortTableByDate();
    checkCallDates();

    // –ü—ñ—Å–ª—è HTMX
    document.body.addEventListener('htmx:afterSwap', function () {
        sortTableByDate();
        checkCallDates();
    });
</script>