{% load static %}
{% load myapp_filters %}

<!-- –§—ñ–ª—å—Ç—Ä–∏ -->
<div class="card filters-card">
    <div class="page-header" style="margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--color-border);">
        <p style="margin: 0;">–í—Å–µ–≥–æ: <strong>{{ total_count }} –∫–æ–º–ø–∞–Ω–∏–π</strong> | –ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π: <strong>+{{ new_count }}</strong></p>
    </div>
    <div class="filters">
        <div class="filter-group">
            <label class="filter-label">–°—Ç–∞—Ç—É—Å</label>
            <div class="multiselect-dropdown">
                <button type="button" class="multiselect-trigger" data-filter="status">
                    <span class="multiselect-text">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</span>
                    <span class="dropdown__arrow">‚ñæ</span>
                </button>
                <div class="multiselect-options">
                    {% for status in all_statuses %}
                    <div class="multiselect-option">
                        <input type="checkbox" id="status-{{ status.id }}" value="{{ status.name }}" data-filter="status" name="status" {% if status.name in selected_statuses %}checked{% endif %}>
                        <label for="status-{{ status.id }}">{{ status.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">–ì–æ—Ä–æ–¥</label>
            <div class="multiselect-dropdown">
                <button type="button" class="multiselect-trigger" data-filter="city">
                    <span class="multiselect-text">–í—Å–µ –≥–æ—Ä–æ–¥–∞</span>
                    <span class="dropdown__arrow">‚ñæ</span>
                </button>
                <div class="multiselect-options">
                    <input type="text" class="city-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥—É..." style="width: 100%; padding: var(--spacing-xs) var(--spacing-sm); border-bottom: 1px solid var(--color-border); font-size: var(--font-size-sm);">
                    {% for city in all_cities %}
                    <div class="multiselect-option" data-city-name="{{ city.name|lower }}">
                        <input type="checkbox" id="city-{{ city.id }}" value="{{ city.name }}" data-filter="city" name="city" {% if city.name in selected_cities %}checked{% endif %}>
                        <label for="city-{{ city.id }}">{{ city.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</label>
            <div style="display: flex; gap: var(--spacing-xs); align-items: center;">
                <input type="date" class="form-control" name="date_updated_from" value="{{ date_updated_from|default:'' }}" style="font-size: 0.75rem; padding: var(--spacing-xs);" placeholder="–û—Ç">
                <span style="color: var(--color-text-light);">-</span>
                <input type="date" class="form-control" name="date_updated_to" value="{{ date_updated_to|default:'' }}" style="font-size: 0.75rem; padding: var(--spacing-xs);" placeholder="–î–æ">
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">–†–∞–∑–¥–µ–ª</label>
            <select class="form-select filter-select" name="category" data-filter="category">
                <option value="">–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã</option>
                {% for category in all_categories %}
                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">–î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</label>
            <div style="display: flex; gap: var(--spacing-xs); align-items: center;">
                <input type="date" class="form-control" name="call_date_from" value="{{ call_date_from|default:'' }}" style="font-size: 0.75rem; padding: var(--spacing-xs);" placeholder="–û—Ç">
                <span style="color: var(--color-text-light);">-</span>
                <input type="date" class="form-control" name="call_date_to" value="{{ call_date_to|default:'' }}" style="font-size: 0.75rem; padding: var(--spacing-xs);" placeholder="–î–æ">
            </div>
        </div>
        
        <div class="filter-group" style="flex: 0 0 auto;">
            <a href="{% url 'myapp:company_list' %}" hx-get="{% url 'myapp:company_list' %}" hx-target="#main-content" hx-push-url="true" class="button button--sm button--secondary button-reset-filters" style="white-space: nowrap; padding: var(--spacing-xs) var(--spacing-sm); min-width: 40px; display: flex; align-items: center; justify-content: center;" title="–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏">‚úï</a>
        </div>
    </div>
    
    <!-- –ê–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ -->
    {% if selected_statuses or selected_cities or selected_category or date_updated_from or date_updated_to or call_date_from or call_date_to %}
    <div class="active-filters" style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background-color: var(--color-bg-light); border-radius: var(--radius-base); display: flex; flex-wrap: wrap; gap: var(--spacing-xs); align-items: center;">
        <span style="font-weight: var(--font-weight-medium); color: var(--color-text); margin-right: var(--spacing-xs);">–ê–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏:</span>
        {% for status in selected_statuses %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            {{ status }}
            <button type="button" class="remove-filter-tag" data-filter="status" data-value="{{ status }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endfor %}
        {% for city in selected_cities %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            {{ city }}
            <button type="button" class="remove-filter-tag" data-filter="city" data-value="{{ city }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endfor %}
        {% if selected_category %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            {% for category in all_categories %}{% if category.id|stringformat:"s" == selected_category %}{{ category.name }}{% endif %}{% endfor %}
            <button type="button" class="remove-filter-tag" data-filter="category" data-value="{{ selected_category }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endif %}
        {% if date_updated_from %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            –û–Ω–æ–≤–ª–µ–Ω–æ –≤—ñ–¥: {{ date_updated_from }}
            <button type="button" class="remove-filter-tag" data-filter="date_updated_from" data-value="{{ date_updated_from }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endif %}
        {% if date_updated_to %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            –û–Ω–æ–≤–ª–µ–Ω–æ –¥–æ: {{ date_updated_to }}
            <button type="button" class="remove-filter-tag" data-filter="date_updated_to" data-value="{{ date_updated_to }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endif %}
        {% if call_date_from %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            –î–∑–≤—ñ–Ω–æ–∫ –≤—ñ–¥: {{ call_date_from }}
            <button type="button" class="remove-filter-tag" data-filter="call_date_from" data-value="{{ call_date_from }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endif %}
        {% if call_date_to %}
        <span class="filter-tag" style="background-color: var(--color-primary); color: white; padding: var(--spacing-xs) var(--spacing-sm); border-radius: var(--radius-sm); font-size: var(--font-size-sm); display: inline-flex; align-items: center; gap: var(--spacing-xs);">
            –î–∑–≤—ñ–Ω–æ–∫ –¥–æ: {{ call_date_to }}
            <button type="button" class="remove-filter-tag" data-filter="call_date_to" data-value="{{ call_date_to }}" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">√ó</button>
        </span>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- –¢–∞–±–ª–∏—Ü—è –∫–æ–º–ø–∞–Ω—ñ–π -->
<div class="card">
    <div class="table-responsive">
        <table class="table company-table">
            <thead class="table__head">
                <tr>
                    <th class="table__th">ID</th>
                    <th class="table__th">–õ–æ–≥–æ + –ò–º—è</th>
                    <th class="table__th">–¢–µ–ª–µ—Ñ–æ–Ω + –ò–º—è</th>
                    <th class="table__th">Instagram</th>
                    <th class="table__th">–°–∞–π—Ç</th>
                    <th class="table__th">–°—Ç–∞—Ç—É—Å</th>
                    <th class="table__th">–ì–æ—Ä–æ–¥</th>
                    <th class="table__th">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                    <th class="table__th">–†–∞–∑–¥–µ–ª</th>
                    <th class="table__th">–î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞</th>
                    <th class="table__th">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th class="table__th">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for company in page_obj %}
                <tr class="table__row" data-status="{{ company.status.name|default:'' }}" data-city="{{ company.city.name|default:'' }}"
                    data-updated="{{ company.updated_at|date:'Y-m-d' }}">
                    <td class="table__td">
                        <span class="text-muted">{{ company.client_id|default:company.id }}</span>
                    </td>
                    <td class="table__td">
                        <div class="company-cell">
                            {% if company.logo %}
                            <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo" title="{{ company.name }}">
                            {% else %}
                            <div class="company-logo company-logo--placeholder" title="{{ company.name }}">üè¢</div>
                            {% endif %}
                            <a href="{% url 'myapp:company_detail' company.id %}" hx-get="{% url 'myapp:company_detail' company.id %}"
                                hx-target="#main-content" hx-push-url="true" class="company-name-link">{{ company.name }}</a>
                        </div>
                    </td>
                    <td class="table__td">
                        <div class="phone-cell">
                            {% if company.favorite_phone %}
                            <span class="phone-number">{{ company.favorite_phone.number }}</span>
                            <span class="contact-name">{{ company.favorite_phone.contact_name|default:'' }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="table__td">
                        {% if company.instagram %}
                        <a href="https://instagram.com/{{ company.instagram|remove:'@' }}" target="_blank" rel="noopener">{{ company.instagram }}</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="table__td">
                        {% if company.on_site_url %}
                        <a href="{{ company.on_site_url }}" target="_blank" rel="noopener" class="website-link" title="–ù–∞ —Å–∞–π—Ç">ü™ê</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="table__td">
                        <span class="badge {{ company.status_badge_class }}">{{ company.status.name|default:'-' }}</span>
                    </td>
                    <td class="table__td">
                        <div>{{ company.city.name|default:'-' }}</div>
                        {% for address in company.addresses.all %}
                        {% if address.is_favorite %}
                        <div style="font-size: 0.75rem; color: var(--color-text-light); margin-top: 2px;">{{ address.address|truncatewords:5 }}</div>
                        {% endif %}
                        {% endfor %}
                    </td>
                    <td class="table__td">{{ company.updated_at|date:"d.m.Y" }}</td>
                    <td class="table__td">
                        <span class="badge {{ company.category_badge_class }}">{{ company.category.name|default:'-' }}</span>
                    </td>
                    <td class="table__td">
                        {% if company.call_date %}
                        {% now "Y-m-d" as today_str %}
                        {% if company.call_date|date:"Y-m-d" < today_str %}
                        <span class="call-date call-date--overdue" data-call-date="{{ company.call_date|date:'Y-m-d' }}">{{ company.call_date|date:"d.m.Y" }}</span>
                        {% else %}
                        <span class="call-date call-date--upcoming" data-call-date="{{ company.call_date|date:'Y-m-d' }}">{{ company.call_date|date:"d.m.Y" }}</span>
                        {% endif %}
                        {% else %}
                        <span class="call-date" data-call-date="">-</span>
                        {% endif %}
                    </td>
                    <td class="table__td">{{ company.short_comment|default:"-"|truncatewords:5 }}</td>
                    <td class="table__td">
                        <div class="table-actions">
                            <button type="button" 
                                    class="icon-btn favorite-btn {% if company.id in favorite_company_ids %}favorite-btn--active{% endif %}" 
                                    data-id="{{ company.id }}"
                                    hx-post="{% url 'myapp:company_toggle_favorite' company.id %}"
                                    hx-trigger="click"
                                    hx-swap="none"
                                    title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">{% if company.id in favorite_company_ids %}üåü{% else %}‚≠ê{% endif %}</button>
                            {% if company.telegram %}
                            <a href="https://t.me/{{ company.telegram|remove:'@' }}" target="_blank" rel="noopener" class="icon-btn" title="Telegram" onclick="window.open(this.href, '_blank', 'noopener,noreferrer'); return false;">üí¨</a>
                            {% endif %}
                            <a href="{% url 'myapp:company_edit' company.id %}" hx-get="{% url 'myapp:company_edit' company.id %}"
                                hx-target="#main-content" hx-push-url="true" class="icon-btn"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            <button type="button" class="icon-btn" title="–£–¥–∞–ª–∏—Ç—å"
                                hx-get="{% url 'myapp:company_delete' company.id %}" hx-target="body"
                                hx-swap="beforeend">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" class="table__td text-center" style="padding: var(--spacing-2xl);">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: var(--spacing-md);">
                            <div style="font-size: 3rem;">üì≠</div>
                            <p class="text-muted" style="font-size: var(--font-size-lg); margin: 0;">–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            {% if search_query or selected_statuses or selected_cities or selected_category %}
                            <p class="text-muted" style="font-size: var(--font-size-sm); margin: 0;">–°–ø—Ä–æ–±—É–π—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –ø–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç</p>
                            <a href="{% url 'myapp:company_list' %}" hx-get="{% url 'myapp:company_list' %}" hx-target="#main-content" hx-push-url="true" class="button button--primary button--sm">–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</a>
                            {% else %}
                            <a href="{% url 'myapp:company_create' %}" hx-get="{% url 'myapp:company_create' %}" hx-target="#main-content" hx-push-url="true" class="button button--primary button--sm">+ –î–æ–¥–∞—Ç–∏ –∫–æ–º–ø–∞–Ω—ñ—é</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
           hx-get="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
           hx-target="#main-content" 
           hx-push-url="true"
           class="pagination__btn pagination__btn--prev">‚Üê –ù–∞–∑–∞–¥</a>
        {% else %}
        <button type="button" class="pagination__btn pagination__btn--prev" disabled>‚Üê –ù–∞–∑–∞–¥</button>
        {% endif %}
        
        <span class="pagination__info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
        
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
           hx-get="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
           hx-target="#main-content" 
           hx-push-url="true"
           class="pagination__btn pagination__btn--next">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
        {% else %}
        <button type="button" class="pagination__btn pagination__btn--next" disabled>–í–ø–µ—Ä–µ–¥ ‚Üí</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<script defer>
    // ==========================================================================
    // Multiselect Dropdown
    // ==========================================================================
    document.addEventListener('click', function (e) {
        const trigger = e.target.closest('.multiselect-trigger');
        if (trigger) {
            e.preventDefault();
            e.stopPropagation();
            const dropdown = trigger.closest('.multiselect-dropdown');
            const isOpen = dropdown.classList.contains('is-open');

            // –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ —ñ–Ω—à—ñ
            document.querySelectorAll('.multiselect-dropdown.is-open').forEach(function (open) {
                if (open !== dropdown) open.classList.remove('is-open');
            });

            // –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π
            if (isOpen) {
                dropdown.classList.remove('is-open');
            } else {
                dropdown.classList.add('is-open');
            }
        } else if (!e.target.closest('.multiselect-dropdown')) {
            // –ó–∞–∫—Ä–∏—Ç–∏ –≤—Å—ñ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞
            document.querySelectorAll('.multiselect-dropdown.is-open').forEach(function (dropdown) {
                dropdown.classList.remove('is-open');
            });
        }
    });

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É multiselect
    function updateMultiselectText(dropdown) {
        const checked = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const text = dropdown.querySelector('.multiselect-text');
        if (checked.length === 0) {
            const filter = dropdown.querySelector('.multiselect-trigger').getAttribute('data-filter');
            text.textContent = filter === 'status' ? '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã' : '–í—Å–µ –≥–æ—Ä–æ–¥–∞';
        } else if (checked.length === 1) {
            text.textContent = checked[0].value;
        } else {
            text.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${checked.length}`;
        }
    }

    // ==========================================================================
    // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ backend (HTMX)
    // ==========================================================================
    function buildFilterUrl() {
        const params = new URLSearchParams();
        
        // –ü–æ—à—É–∫
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput && searchInput.value) {
            params.append('search', searchInput.value);
        }
        
        // –°—Ç–∞—Ç—É—Å–∏
        const statusChecks = document.querySelectorAll('input[name="status"]:checked');
        statusChecks.forEach(function (cb) {
            params.append('status', cb.value);
        });
        
        // –ú—ñ—Å—Ç–∞
        const cityChecks = document.querySelectorAll('input[name="city"]:checked');
        cityChecks.forEach(function (cb) {
            params.append('city', cb.value);
        });
        
        // –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
        const categorySelect = document.querySelector('select[name="category"]');
        if (categorySelect && categorySelect.value) {
            params.append('category', categorySelect.value);
        }
        
        // –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–≤—ñ–¥-–¥–æ)
        const dateUpdatedFrom = document.querySelector('input[name="date_updated_from"]');
        if (dateUpdatedFrom && dateUpdatedFrom.value) {
            params.append('date_updated_from', dateUpdatedFrom.value);
        }
        const dateUpdatedTo = document.querySelector('input[name="date_updated_to"]');
        if (dateUpdatedTo && dateUpdatedTo.value) {
            params.append('date_updated_to', dateUpdatedTo.value);
        }
        
        // –î–∞—Ç–∞ –¥–∑–≤—ñ–Ω–∫–∞ (–≤—ñ–¥-–¥–æ)
        const callDateFrom = document.querySelector('input[name="call_date_from"]');
        if (callDateFrom && callDateFrom.value) {
            params.append('call_date_from', callDateFrom.value);
        }
        const callDateTo = document.querySelector('input[name="call_date_to"]');
        if (callDateTo && callDateTo.value) {
            params.append('call_date_to', callDateTo.value);
        }
        
        return '{% url "myapp:company_list" %}?' + params.toString();
    }

    function applyFilters() {
        const url = buildFilterUrl();
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ HTMX –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        if (typeof htmx !== 'undefined') {
            htmx.ajax('GET', url, {
                target: '#main-content',
                swap: 'innerHTML',
                pushUrl: true
            });
        } else {
            // Fallback - –∑–≤–∏—á–∞–π–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
            window.location.href = url;
        }
    }

    // –û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω checkbox —Ç–∞ select —Ç–∞ date input
    document.addEventListener('change', function (e) {
        if (e.target.matches('input[data-filter], select[data-filter], input[name="date_updated_from"], input[name="date_updated_to"], input[name="call_date_from"], input[name="call_date_to"]')) {
            if (e.target.matches('input[data-filter]')) {
                const dropdown = e.target.closest('.multiselect-dropdown');
                if (dropdown) {
                    updateMultiselectText(dropdown);
                }
            }
            // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ —á–µ—Ä–µ–∑ backend
            applyFilters();
        }
    });

    // ==========================================================================
    // –í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–∫—Ä–µ–º–∏—Ö —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    // ==========================================================================
    document.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-filter-tag');
        if (!removeBtn) return;
        
        e.preventDefault();
        
        const filterType = removeBtn.getAttribute('data-filter');
        const filterValue = removeBtn.getAttribute('data-value');
        
        // –ë—É–¥—É—î–º–æ URL –±–µ–∑ —Ü—å–æ–≥–æ —Ñ—ñ–ª—å—Ç—Ä–∞
        const params = new URLSearchParams();
        
        // –ü–æ—à—É–∫
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput && searchInput.value) {
            params.append('search', searchInput.value);
        }
        
        // –°—Ç–∞—Ç—É—Å–∏ (–±–µ–∑ –≤–∏–¥–∞–ª–µ–Ω–æ–≥–æ)
        const statusChecks = document.querySelectorAll('input[name="status"]:checked');
        statusChecks.forEach(function (cb) {
            if (filterType === 'status' && cb.value === filterValue) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤–∏–¥–∞–ª–µ–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä
            }
            params.append('status', cb.value);
        });
        
        // –ú—ñ—Å—Ç–∞ (–±–µ–∑ –≤–∏–¥–∞–ª–µ–Ω–æ–≥–æ)
        const cityChecks = document.querySelectorAll('input[name="city"]:checked');
        cityChecks.forEach(function (cb) {
            if (filterType === 'city' && cb.value === filterValue) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤–∏–¥–∞–ª–µ–Ω–∏–π —Ñ—ñ–ª—å—Ç—Ä
            }
            params.append('city', cb.value);
        });
        
        // –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
        const categorySelect = document.querySelector('select[name="category"]');
        if (categorySelect && categorySelect.value && filterType !== 'category') {
            params.append('category', categorySelect.value);
        }
        
        // –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        const dateUpdatedFrom = document.querySelector('input[name="date_updated_from"]');
        if (dateUpdatedFrom && dateUpdatedFrom.value && filterType !== 'date_updated_from') {
            params.append('date_updated_from', dateUpdatedFrom.value);
        }
        const dateUpdatedTo = document.querySelector('input[name="date_updated_to"]');
        if (dateUpdatedTo && dateUpdatedTo.value && filterType !== 'date_updated_to') {
            params.append('date_updated_to', dateUpdatedTo.value);
        }
        
        // –î–∞—Ç–∞ –¥–∑–≤—ñ–Ω–∫–∞
        const callDateFrom = document.querySelector('input[name="call_date_from"]');
        if (callDateFrom && callDateFrom.value && filterType !== 'call_date_from') {
            params.append('call_date_from', callDateFrom.value);
        }
        const callDateTo = document.querySelector('input[name="call_date_to"]');
        if (callDateTo && callDateTo.value && filterType !== 'call_date_to') {
            params.append('call_date_to', callDateTo.value);
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ URL –±–µ–∑ —Ñ—ñ–ª—å—Ç—Ä–∞
        const url = '{% url "myapp:company_list" %}?' + params.toString();
        if (typeof htmx !== 'undefined') {
            htmx.ajax('GET', url, {
                target: '#main-content',
                swap: 'innerHTML',
                pushUrl: true
            });
        } else {
            window.location.href = url;
        }
    });

    // ==========================================================================
    // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ –¥–∞—Ç—ñ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ω–æ–≤—ñ –∑–≤–µ—Ä—Ö—É)
    // ==========================================================================
    function sortTableByDate() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

        rows.sort(function (a, b) {
            const aId = a.querySelector('.favorite-btn')?.getAttribute('data-id');
            const bId = b.querySelector('.favorite-btn')?.getAttribute('data-id');
            const aFav = favorites.includes(aId) ? 0 : 1;
            const bFav = favorites.includes(bId) ? 0 : 1;

            if (aFav !== bFav) return aFav - bFav;

            const aDate = a.getAttribute('data-updated') || '';
            const bDate = b.getAttribute('data-updated') || '';
            return bDate.localeCompare(aDate);
        });

        rows.forEach(function (row) {
            tbody.appendChild(row);
        });
    }

    // ==========================================================================
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ—ó –¥–∞—Ç–∏ –∑–≤–æ–Ω–∫–∞
    // ==========================================================================
    function checkCallDates() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll('.call-date[data-call-date]').forEach(function (el) {
            const dateStr = el.getAttribute('data-call-date');
            if (!dateStr || dateStr === '-') return;

            const callDate = new Date(dateStr);
            callDate.setHours(0, 0, 0, 0);

            el.classList.remove('past', 'future');
            if (callDate < today) {
                el.classList.add('past');
            } else {
                el.classList.add('future');
            }
        });
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    sortTableByDate();
    checkCallDates();

    // –ü—ñ—Å–ª—è HTMX
    document.body.addEventListener('htmx:afterSwap', function () {
        sortTableByDate();
        checkCallDates();
        initFavoriteButtons();
    });

    // ==========================================================================
    // Favorite —Å–∏—Å—Ç–µ–º–∞ (–∑—ñ—Ä–∫–∞ –¥–ª—è —Ä–∞–Ω–∂—É–≤–∞–Ω–Ω—è)
    // ==========================================================================
    function initFavoriteButtons() {
        document.querySelectorAll('.favorite-btn').forEach(function(btn) {
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const companyId = this.getAttribute('data-id');
                const url = this.getAttribute('hx-post');
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'HX-Request': 'true'
                    }
                }).then(function(response) {
                    return response.text();
                }).then(function(data) {
                    // –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ –∫–ª–∞—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ emoji
                    if (newBtn.classList.contains('favorite-btn--active')) {
                        newBtn.classList.remove('favorite-btn--active');
                        newBtn.textContent = '‚≠ê';
                    } else {
                        newBtn.classList.add('favorite-btn--active');
                        newBtn.textContent = 'üåü';
                    }
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω—ñ–π
                    const currentUrl = window.location.href.split('?')[0];
                    const params = new URLSearchParams(window.location.search);
                    htmx.ajax('GET', currentUrl + '?' + params.toString(), {
                        target: '#main-content',
                        swap: 'innerHTML'
                    });
                });
            });
        });
    }
    
    initFavoriteButtons();
</script>