{% load static %}

<!-- –¢—ñ–ª—å–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è HTMX (–±–µ–∑ layout) -->
<!-- Header + Actions -->
<div class="card company-header">
    <div class="company-header-top">
        <div class="company-header-info">
            {% if company.logo %}
            <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo-detail">
            {% else %}
            <div class="company-logo-detail company-logo-placeholder">üè¢</div>
            {% endif %}
            <div>
                <h1>{{ company.name }}</h1>
                <span class="badge {{ company.status.badge_class }}">{{ company.status.name }}</span>
            </div>
        </div>
        <div class="company-actions">
            <a href="{% url 'myapp:company_edit' company.id %}" hx-get="{% url 'myapp:company_edit' company.id %}" hx-target="#main-content" hx-push-url="true"
                class="button button--sm button--primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <button type="button" class="button button--sm button--danger" hx-get="{% url 'myapp:company_delete' company.id %}" hx-target="body" hx-swap="beforeend">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <a href="{% url 'myapp:company_export' company.id %}" class="button button--sm button--secondary" download>üìä –≠–∫—Å–ø–æ—Ä—Ç</a>
        </div>
    </div>
    <div class="company-id">ID: {{ company.client_id }}</div>
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç (2 –∫–æ–ª–æ–Ω–∫–∏) -->
<div class="company-content">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (70%) -->
    <div class="company-main">
        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="card">
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã:</span>
                    <div class="phone-list">
                        {% for phone in company.phones.all %}
                        <div class="phone-item">
                            <span>{{ phone.number }}</span>
                            {% if phone.is_favorite %}<span class="phone-star">‚≠ê</span>{% endif %}
                            <span class="phone-name">{{ phone.contact_name }}</span>
                        </div>
                        {% empty %}
                        <span class="text-muted" style="font-style: italic;">–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤</span>
                        {% endfor %}
                    </div>
                </div>
                {% if company.telegram %}
                <div class="info-item">
                    <span class="info-label">üí¨ Telegram:</span>
                    <a href="https://t.me/{{ company.telegram|slice:"1:" }}" target="_blank" rel="noopener" class="telegram-link">{{ company.telegram }}</a>
                </div>
                {% endif %}
                {% if company.website %}
                <div class="info-item">
                    <span class="info-label">üåê –°–∞–π—Ç:</span>
                    <a href="{{ company.website }}" target="_blank" rel="noopener">{{ company.website|slice:"8:" }}</a>
                </div>
                {% endif %}
                {% if company.instagram %}
                <div class="info-item">
                    <span class="info-label">üì∑ Instagram:</span>
                    <a href="https://instagram.com/{{ company.instagram|slice:"1:" }}" target="_blank" rel="noopener">{{ company.instagram }}</a>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">üìç –ì–æ—Ä–æ–¥:</span>
                    <span>{{ company.city }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">üè∑Ô∏è –†–∞–∑–¥–µ–ª:</span>
                    {% if company.category %}
                    <span class="badge badge-category" 
                          data-bg-color="{{ company.category.badge_color_bg }}"
                          data-fg-color="{{ company.category.badge_color_fg }}">{{ company.category.name }}</span>
                    {% else %}
                    <span class="badge badge--secondary">-</span>
                    {% endif %}
                </div>
                {% if company.keywords %}
                <div class="info-item">
                    <span class="info-label">üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</span>
                    <span>{{ company.keywords }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
        <div class="card">
            <div class="short-comment-block">
                <h4>–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
                <p class="short-comment-text" 
                   contenteditable="true" 
                   data-company-id="{{ company.id }}"
                   data-save-url="{% url 'myapp:company_update_short_comment' company.id %}">{{ company.short_comment }}</p>
                <small class="text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>
            </div>
        </div>

        <!-- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
        <div class="card">
            <h4>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h4>
            <p>{{ company.full_description }}</p>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (30%) -->
    <div class="company-sidebar">
        <!-- –î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞ -->
        <div class="card call-date-card">
            <h4>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</h4>
            <div class="call-date-display">
                <span class="call-date-value" contenteditable="false">{{ company.call_date_display }}</span>
                <button class="btn-edit-date" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            </div>
            <input type="date" 
                   class="call-date-input" 
                   value="{{ company.call_date|date:'Y-m-d'|default:'' }}"
                   data-company-id="{{ company.id }}"
                   data-save-url="{% url 'myapp:company_update_call_date' company.id %}">
        </div>

        <!-- –î–∞—Ç—ã -->
        <div class="card">
            <div class="info-item">
                <span class="info-label">üìÖ –°–æ–∑–¥–∞–Ω–æ:</span>
                <span>{{ company.created_date }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                <span>{{ company.updated_date }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">üîñ –°—Ç–∞—Ç—É—Å:</span>
                <span class="badge {{ company.status_badge }}">{{ company.status }}</span>
            </div>
        </div>
    </div>
</div>

<!-- –°–ª–∞–π–¥–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π -->
{% if company.photos %}
<div class="card">
    <div class="card__header">
        <h3 class="card__title">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h3>
    </div>
    <div class="photo-slider">
        <button type="button" class="slider-btn slider-btn--prev">‚Üê</button>
        {% for photo in company.photos %}
        <div class="photo-item">
            <img src="{{ photo }}" alt="–§–æ—Ç–æ {{ forloop.counter }}">
            <button type="button" 
                    class="button button--sm button--danger photo-delete-btn"
                    hx-post="{% url 'myapp:company_delete_photo' company.id %}"
                    hx-vals='{"photo_url": "{{ photo }}"}'
                    hx-target="#main-content"
                    hx-push-url="true"
                    onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ —Ñ–æ—Ç–æ?')"
                    title="–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ">üóëÔ∏è</button>
        </div>
        {% endfor %}
        <button type="button" class="slider-btn slider-btn--next">‚Üí</button>
    </div>
</div>
{% endif %}

<!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
<div class="card comments-card">
    <h3>–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h3>

    <div class="comments-timeline" id="comments-list">
        {% for comment in company.comments.all %}
        <div class="comment{% if forloop.counter > 3 %} comment--hidden{% endif %}" data-comment-id="{{ comment.id }}">
            <div class="comment-header">
                <span class="comment-author">üë§ {{ comment.author_name|default:"–ê–Ω–æ–Ω–∏–º" }}</span>
                <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                <button class="btn-delete-comment" 
                        data-comment-id="{{ comment.id }}"
                        hx-post="{% url 'myapp:company_comment_delete' company.id comment.id %}"
                        hx-target="#main-content"
                        hx-push-url="true"
                        title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
            <div class="comment-text">
                {{ comment.text }}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-light);">
            <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üí¨</div>
            <p style="margin: 0; font-style: italic;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
            <p style="margin: var(--spacing-xs) 0 0 0; font-size: var(--font-size-sm);">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∏–∂–µ</p>
        </div>
        {% endfor %}
    </div>

    {% if company.comments.count > 3 %}
    <button class="btn-expand-comments">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è -->
    <form class="add-comment-form" 
          method="post" 
          action="{% url 'myapp:company_comment_add' company.id %}"
          hx-post="{% url 'myapp:company_comment_add' company.id %}"
          hx-target="#main-content"
          hx-push-url="true">
        {% csrf_token %}
        <textarea class="form-control" name="comment" rows="2" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
            required></textarea>
        <button type="submit" class="button button--primary button--sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>