{% load static %}
{% load myapp_filters %}

<!-- –¢—ñ–ª—å–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è HTMX (–±–µ–∑ layout) -->
<!-- Header + Actions -->
<div class="card company-header">
    <div class="company-header-top">
        <div class="company-header-info" id="logo-container">
            {% if company.logo %}
            <div class="logo-wrapper" style="position: relative; display: inline-block;">
                <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo-detail">
                <button type="button" 
                        class="button button--sm button--danger"
                        style="position: absolute; top: 5px; right: 5px; padding: 2px 6px; font-size: 0.75rem;"
                        hx-post="{% url 'myapp:company_delete_logo' company.id %}"
                        hx-target="#logo-container"
                        hx-swap="innerHTML swap:300ms"
                        title="–í–∏–¥–∞–ª–∏—Ç–∏ –ª–æ–≥–æ—Ç–∏–ø">üóëÔ∏è</button>
            </div>
            {% else %}
            <div class="company-logo-detail company-logo-placeholder">üè¢</div>
            {% endif %}
            <div>
                <h1>{{ company.name }}</h1>
                <span class="badge {{ company.status.badge_class }}">{{ company.status.name }}</span>
            </div>
        </div>
        <div class="company-actions">
            <a href="{% url 'myapp:company_list' %}" hx-get="{% url 'myapp:company_list' %}" hx-target="#main-content" hx-push-url="true"
                class="button button--sm button--secondary" title="–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É">‚Üê –ù–∞–∑–∞–¥</a>
            <a href="{% url 'myapp:company_edit' company.id %}" hx-get="{% url 'myapp:company_edit' company.id %}" hx-target="#main-content" hx-push-url="true"
                class="button button--sm button--primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <button type="button" class="button button--sm button--danger" hx-get="{% url 'myapp:company_delete' company.id %}" hx-target="body" hx-swap="beforeend">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <a href="{% url 'myapp:company_export' company.id %}" class="button button--sm button--secondary" download>üìä –≠–∫—Å–ø–æ—Ä—Ç</a>
        </div>
    </div>
    <div class="company-id">ID: {{ company.client_id }}</div>
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç (2 –∫–æ–ª–æ–Ω–∫–∏) -->
<div class="company-content">
    <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (70%) -->
    <div class="company-main">
        <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
        <div class="card">
            <div class="info-list">
                <div class="info-item">
                    <span class="info-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã:</span>
                    <div class="phone-list">
                        {% for phone in company.phones.all %}
                        <div class="phone-item">
                            <span>{{ phone.number }}</span>
                            <span class="phone-name">{{ phone.contact_name }}</span>
                        </div>
                        {% empty %}
                        <span class="text-muted" style="font-style: italic;">–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤</span>
                        {% endfor %}
                    </div>
                </div>
                {% if company.addresses.all %}
                <div class="info-item">
                    <span class="info-label">üìç –ê–¥—Ä–µ—Å–∞:</span>
                    <div class="address-list">
                        {% for address in company.addresses.all %}
                        <div class="address-item">
                            <span>{{ address.address }}</span>
                            {% if address.is_favorite %}<span style="color: var(--color-warning);">‚≠ê</span>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if company.telegram %}
                <div class="info-item">
                    <span class="info-label">üí¨ Telegram:</span>
                    <a href="https://t.me/{{ company.telegram|remove:'@' }}" target="_blank" rel="noopener" class="telegram-link">{{ company.telegram }}</a>
                </div>
                {% endif %}
                {% if company.website %}
                <div class="info-item">
                    <span class="info-label">üåê –°–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏:</span>
                    <a href="{{ company.website }}" target="_blank" rel="noopener" title="{{ company.website }}">{{ company.website }}</a>
                </div>
                {% endif %}
                {% if company.on_site_url %}
                <div class="info-item">
                    <span class="info-label">ü™ê –ï—Å—Ç—å –Ω–∞ —Å–∞–π—Ç–µ:</span>
                    <a href="{{ company.on_site_url }}" target="_blank" rel="noopener" title="{{ company.on_site_url }}">{{ company.on_site_url }}</a>
                </div>
                {% endif %}
                {% if company.instagram %}
                <div class="info-item">
                    <span class="info-label">üì∑ Instagram:</span>
                    <a href="https://instagram.com/{{ company.instagram|remove:'@' }}" target="_blank" rel="noopener">{{ company.instagram }}</a>
                </div>
                {% endif %}
                <div class="info-item">
                    <span class="info-label">üìç –ì–æ—Ä–æ–¥:</span>
                    <span>{{ company.city }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">üè∑Ô∏è –†–∞–∑–¥–µ–ª:</span>
                    {% if company.category %}
                    <span class="badge badge-category" 
                          data-bg-color="{{ company.category.badge_color_bg }}"
                          data-fg-color="{{ company.category.badge_color_fg }}">{{ company.category.name }}</span>
                    {% else %}
                    <span class="badge badge--secondary">-</span>
                    {% endif %}
                </div>
                {% if company.keywords %}
                <div class="info-item">
                    <span class="info-label">üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</span>
                    <span>{{ company.keywords }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è) -->
        {% if company.short_comment %}
        <div class="card">
            <div class="short-comment-block">
                <h4>–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
                <p class="short-comment-text" 
                   contenteditable="true" 
                   data-company-id="{{ company.id }}"
                   data-save-url="{% url 'myapp:company_update_short_comment' company.id %}">{{ company.short_comment }}</p>
                <small class="text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>
            </div>
        </div>
        {% endif %}

        <!-- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
        {% if company.full_description %}
        <div class="card">
            <h4>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h4>
            <div class="full-description-content" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">{{ company.full_description|safe }}</div>
        </div>
        {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ (30%) -->
    <div class="company-sidebar">
        <!-- –ù–∞ —Å–∞–π—Ç (—è–∫—â–æ —î website) -->
        {% if company.website %}
        <div class="card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; margin-bottom: var(--spacing-md);">
            <a href="{{ company.website }}" target="_blank" rel="noopener" style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md); text-decoration: none; color: #1e40af; font-weight: var(--font-weight-semibold);" onclick="window.open(this.href, '_blank', 'noopener,noreferrer'); return false;">
                <span style="font-size: 1.5rem;">üåê</span>
                <span>–ù–∞ —Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏</span>
            </a>
        </div>
        {% endif %}
        
        <!-- –ï—Å—Ç—å –Ω–∞ —Å–∞–π—Ç–µ (—è–∫—â–æ —î on_site_url) -->
        {% if company.on_site_url %}
        <div class="card" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 2px solid #6366f1; margin-bottom: var(--spacing-md);">
            <a href="{{ company.on_site_url }}" target="_blank" rel="noopener" style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md); text-decoration: none; color: #4f46e5; font-weight: var(--font-weight-semibold);" onclick="window.open(this.href, '_blank', 'noopener,noreferrer'); return false;">
                <span style="font-size: 1.5rem;">ü™ê</span>
                <span>–í –∫–∞—Ç–∞–ª–æ–≥–µ</span>
            </a>
        </div>
        {% endif %}
        
        <!-- –î–∞—Ç–∞ –∑–≤–æ–Ω–∫–∞ -->
        <div class="card call-date-card">
            <h4>üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</h4>
            <div class="call-date-display" id="call-date-display-{{ company.id }}">
                {% if company.call_date %}
                {% now "Y-m-d" as today_str %}
                {% if company.call_date|date:"Y-m-d" < today_str %}
                <span class="call-date-value call-date--overdue" data-call-date="{{ company.call_date|date:'Y-m-d' }}">{{ company.call_date_display }}</span>
                {% else %}
                <span class="call-date-value call-date--upcoming" data-call-date="{{ company.call_date|date:'Y-m-d' }}">{{ company.call_date_display }}</span>
                {% endif %}
                {% else %}
                <span class="call-date-value" data-call-date="">–ù–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</span>
                {% endif %}
                <button class="btn-edit-date" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            </div>
            <input type="date" 
                   class="call-date-input" 
                   name="call_date"
                   value="{% if company.call_date %}{{ company.call_date|date:'Y-m-d' }}{% endif %}"
                   data-company-id="{{ company.id }}"
                   hx-post="{% url 'myapp:company_update_call_date' company.id %}"
                   hx-trigger="change delay:100ms, blur delay:100ms"
                   hx-target="#call-date-display-{{ company.id }}"
                   hx-swap="innerHTML"
                   style="display: none;">
        </div>

        <!-- –î–∞—Ç—ã -->
        <div class="card">
            <div class="info-item">
                <span class="info-label">üìÖ –°–æ–∑–¥–∞–Ω–æ:</span>
                <span>{{ company.created_date }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                <span>{{ company.updated_date }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">üîñ –°—Ç–∞—Ç—É—Å:</span>
                <span class="badge {{ company.status_badge }}">{{ company.status }}</span>
            </div>
        </div>
    </div>
</div>

<!-- –°–ª–∞–π–¥–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ–π -->
{% if company.photos %}
<div class="card">
    <div class="card__header">
        <h3 class="card__title">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h3>
    </div>
    <div class="photo-slider">
        <button type="button" class="slider-btn slider-btn--prev" onclick="scrollPhotos(-200)">‚Üê</button>
        <div class="photo-slider-wrapper" id="photo-slider-wrapper">
            {% for photo in company.photos %}
            <div class="photo-item" id="photo-{{ forloop.counter0 }}">
                <img src="{{ photo }}" alt="–§–æ—Ç–æ {{ forloop.counter }}">
                <button type="button" 
                        class="button button--sm button--danger photo-delete-btn"
                        style="position: absolute; top: 5px; right: 5px; padding: 2px 6px; font-size: 0.75rem;"
                        hx-post="{% url 'myapp:company_delete_photo' company.id %}"
                        hx-vals='{"photo_url": "{{ photo }}"}'
                        hx-target="#photo-{{ forloop.counter0 }}"
                        hx-swap="outerHTML swap:300ms"
                        title="–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ">üóëÔ∏è</button>
            </div>
            {% endfor %}
        </div>
        <button type="button" class="slider-btn slider-btn--next" onclick="scrollPhotos(200)">‚Üí</button>
    </div>
    <script>
        function scrollPhotos(direction) {
            const wrapper = document.getElementById('photo-slider-wrapper');
            if (wrapper) {
                wrapper.scrollBy({ left: direction, behavior: 'smooth' });
            }
        }
    </script>
</div>
{% endif %}

<!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
<div class="card comments-card">
    <h3>–ò—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h3>

    <div class="comments-timeline" id="comments-list">
        {% include 'components/comments_list.html' with comments=company.comments.all company_id=company.id %}
    </div>

    {% if company.comments.count > 3 %}
    <button class="btn-expand-comments">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
    {% endif %}

    <!-- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è -->
    <form class="add-comment-form" 
          method="post" 
          action="{% url 'myapp:company_comment_add' company.id %}"
          hx-post="{% url 'myapp:company_comment_add' company.id %}"
          hx-target="#comments-list"
          hx-swap="innerHTML">
        {% csrf_token %}
        <textarea class="form-control" name="comment_text" rows="1" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="font-size: 0.875rem; padding: var(--spacing-xs) var(--spacing-sm);" required></textarea>
        <button type="submit" class="button button--primary button--sm" style="font-size: 0.75rem; padding: var(--spacing-xs) var(--spacing-sm);">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ –∫—ñ–Ω—Ü—ñ -->
<div style="padding: var(--spacing-md) 0; text-align: center;">
    <a href="{% url 'myapp:company_list' %}" hx-get="{% url 'myapp:company_list' %}" hx-target="#main-content" hx-push-url="true"
        class="button button--secondary">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Å–ø–∏—Å–∫—É</a>
</div>